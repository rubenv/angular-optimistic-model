angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope","$interval",function(a,b,c){function d(a,b,c){return angular.extend({},a.modelOptions,b,c||{})}function e(a,b){var c,d=new a;if(b&&b.toJSON&&(b=b.toJSON()),d.fromJSON){var e={};for(c in b)"$"!==c[0]&&b.hasOwnProperty(c)&&(e[c]=angular.copy(b[c]));d.fromJSON(e)}else for(c in b)"$"!==c[0]&&b.hasOwnProperty(c)&&(d[c]=angular.copy(b[c]));return d}function f(a){if(angular.isArray(a)){for(var b=[],c=0;c<a.length;c++)b[c]=f(a[c]);return b}var d=e(a.constructor,a);return d[G]=a,d}function g(){return f(this)}function h(){return(new Date).getTime()}function i(){for(var a=Object.keys(L),b=P.now(),d=!1,e=0;e<a.length;e++){var f=a[e],g=L[f];g.lastUse+g.cacheLife<b&&(delete K[f],delete L[f],d=!0)}d&&0===Object.keys(L).length&&(c.cancel(M),M=null,O=N)}function j(a){L[a]&&(L[a].lastUse=P.now())}function k(a,b){if(angular.isArray(a)){for(var c=0;c<a.length;c++)b[c]=a[c];b.length=a.length}else for(var d in a)a.hasOwnProperty(d)&&"_"!==d[0]&&"$"!==d[0]&&(b[d]=a[d])}function l(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];k(c,d)}}function m(a,d,e){if(e){var f=P.now();L[a]={lastUse:f,cacheLife:1e3*e},M?1e3*e<O&&(c.cancel(M),O=1e3*e,M=c(i,O)):M=c(i,O)}l(K,a,d),b.$broadcast(I,a,K[a])}function n(a,b,c,f){var g=d(a,b),h=g.cacheLife||0;if(!f&&angular.isArray(c)&&(f=c,c=g.ns),!f&&angular.isObject(c)&&(f=c,c=g.ns+"/"+f[g.idField]),f)if(angular.isArray(f)){for(var i=[],j=0;j<f.length;j++){var k=e(a,f[j]);g.populateChildren&&m(c+"/"+k[g.idField],k,h),i.push(k)}m(c,i,h)}else m(c,e(a,f),h)}function o(a,b,c,d){d&&a[b]&&a[b][d]&&a[b][d]!==c[d]&&delete a[b],l(a,b,c)}function p(a,b){if(!angular.isArray(a)||!angular.isFunction(b))return a;for(var c=[],d=a.length,e=0;e<d;e++)b(a[e])&&c.push(a[e]);return c}function q(a,b,c,d){c=!!c,a.toScope=function(e,g,h){if(K[b]){j(b);var i=p(K[b],h);o(e,g,c?f(i):i,d)}return a.then(function(a){o(e,g,p(a,h),d),!c&&angular.isArray(a)&&angular.isFunction(h)&&e.$on(I,function(a,c,f){b===c&&o(e,g,p(f,h),d)})}),a.then(function(){return e[g]})}}function r(b){var c=a.defer();return c.resolve(b),c.promise}function s(a,b){var c=a;if(b){var d=Object.keys(b);d.sort();for(var e=[],f=0;f<d.length;f++){var g=d[f];e.push(g+"="+escape(b[g]))}c+="?"+e.join("&")}return c}function t(a,c,d){b.$broadcast("model"+a+"Started",c,d),d["finally"](function(){b.$broadcast("model"+a+"Ended",c,d)})}function u(a,b,c){var e=d(a,b,c),g=s(e.ns,e.query),h=!!e.cloned,i=null;return e.useCached&&K[g]?(j(g),i=r(h?f(K[g]):K[g])):i=e.backend("GET",g,null,"getAll").then(function(b){return n(a,e,g,b),h?f(K[g]):K[g]}),q(i,g,h),i}function v(a,b,c,e){var g=d(a,b,e),h=g.ns+"/"+c,i=!!g.cloned,k=null;return g.useCached&&g.useCachedChildren&&K[h]?(j(h),k=r(i?f(K[h]):K[h])):k=g.backend("GET",h,null,"get").then(function(b){return n(a,g,h,b),i?f(K[h]):K[h]}),q(k,h,i,g.idField),k}function w(a,b){var c=d(a,b);if(!c.useCached)throw new Error("Can only use getAllSync on models that have useCached: true");var e=s(c.ns,c.query);return j(e),K[e]}function x(a,b,c){var e=d(a,b);if(!e.useCached)throw new Error("Can only use getSync on models that have useCached: true");var f=e.ns+"/"+c;return j(f),K[f]}function y(a,b,c,f){var g=d(a,b),h=c;if(f){h={};for(var i=0;i<f.length;i++)h[f[i]]=c[f[i]]}var j=g.ns+"/"+c[g.idField],l=g.backend("PUT",j,h,"update",c).then(function(b){var d=e(a,b);return m(j,d,g.cacheLife||0),k(d,c),delete c[H],K[j]});return q(l,j),t("Update",c,l),l}function z(a,c,e){var f=d(a,c),g="object"==typeof e?e[f.idField]:e,h=f.ns+"/"+g,i=f.backend("DELETE",h,null,"destroy",e).then(function(){delete K[h];var a=K[f.ns];if(a){for(var c=-1,d=0;d<a.length;d++)a[d][f.idField]===g&&(c=d);c>-1&&a.splice(c,1),b.$broadcast(I,f.ns,a)}});return t("Delete",e,i),i}function A(a,c,f){var g=d(a,c);f=f.constructor===a?f:e(a,f);var h=g.backend("POST",g.ns,f,"create",f).then(function(c){var d=e(a,c),h=g.ns+"/"+d[g.idField];m(h,d);var i=K[h];k(c,f),f[G]=i,delete f[H];var j=K[g.ns];if(j){for(var l=!1,n=0;n<j.length;n++)j[n][g.idField]===d[g.idField]&&(l=!0);l||j.push(i),b.$broadcast(I,g.ns,j)}return i});return t("Create",f,h),h}function B(){var a=this,b=a.constructor.modelOptions,c=!!a[H],d=null;return d=a[b.idField]?a.update():a.create(),t("Save",a,d),c?d.then(function(b){return a.snapshot(),b}):d}function C(){var a=this.constructor.modelOptions,b={};if(this[a.idField]){if(!this[G])throw new Error("Only works on clones!");b=this[G],this[H]&&(b=this[H])}else this[H]&&(b=this[H]);return!angular.equals(f(this),b)}function D(){var a=this.constructor.modelOptions;if(this[a.idField]&&!this[G])throw new Error("Only works on clones!");this[H]=f(this)}function E(a,b,c){return function(d){var e=angular.extend({},a.modelOptions,c,d);return b.apply(null,[a,e].concat(Array.prototype.slice.call(arguments,0)))}}function F(a){return function(){var b=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return a.apply(null,b)}}var G="$$cloneParent",H="$$snapshot",I="modelCached",J={idField:"id",populateChildren:!0,useCached:!1,useCachedChildren:!0},K={},L={},M=null,N=6e4,O=N,P={defaults:function(a){J=angular.extend(J,a)},extend:function(a,b){if(a.modelOptions)throw new Error("Cannot extend function that is already an optimistic model!");a.getAll=E(a,u),a.get=E(a,v),a.getCached=E(a,v,{useCached:!0}),a.getClone=E(a,v,{cloned:!0}),a.getAllSync=E(a,w),a.getSync=E(a,x),a.update=E(a,y),a["delete"]=E(a,z),a.create=E(a,A),a.cache=E(a,n),a.modelOptions=angular.extend({},J,b);var c=a.prototype;c.update=F(y),c["delete"]=F(z),c.create=F(A),c.save=B,c.clone=g,c.hasChanges=C,c.snapshot=D},clear:function(){K={}},getCache:function(a){return j(a),K[a]},get:v,getAll:u,update:y,"delete":z,create:A,mkToScope:q,newInstance:e,now:h};return P}]);