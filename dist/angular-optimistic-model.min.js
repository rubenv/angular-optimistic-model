angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope","$interval",function(a,b,c){function d(a,b,c){return angular.extend({},a.modelOptions,b,c||{})}function e(a,b){var c,d=new a;if(b&&b.toJSON&&(b=b.toJSON()),d.fromJSON){var e={};for(c in b)"$"!==c[0]&&b.hasOwnProperty(c)&&(e[c]=angular.copy(b[c]));d.fromJSON(e)}else for(c in b)"$"!==c[0]&&b.hasOwnProperty(c)&&(d[c]=angular.copy(b[c]));return d}function f(a){if(angular.isArray(a)){for(var b=[],c=0;c<a.length;c++)b[c]=f(a[c]);return b}var d=e(a.constructor,a);return d[F]=a,d}function g(){return(new Date).getTime()}function h(){for(var a=Object.keys(K),b=O.now(),d=!1,e=0;e<a.length;e++){var f=a[e],g=K[f];g.lastUse+g.cacheLife<b&&(delete J[f],delete K[f],d=!0)}d&&0===Object.keys(K).length&&(c.cancel(L),L=null,N=M)}function i(a){K[a]&&(K[a].lastUse=O.now())}function j(a,b){if(angular.isArray(a)){for(var c=0;c<a.length;c++)b[c]=a[c];b.length=a.length}else for(var d in a)a.hasOwnProperty(d)&&"_"!==d[0]&&"$"!==d[0]&&(b[d]=a[d])}function k(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];j(c,d)}}function l(a,d,e){if(e){var f=O.now();K[a]={lastUse:f,cacheLife:1e3*e},L?N>1e3*e&&(c.cancel(L),N=1e3*e,L=c(h,N)):L=c(h,N)}k(J,a,d),b.$broadcast(H,a,J[a])}function m(a,b,c,f){var g=d(a,b),h=g.cacheLife||0;if(!f&&angular.isArray(c)&&(f=c,c=g.ns),!f&&angular.isObject(c)&&(f=c,c=g.ns+"/"+f[g.idField]),f)if(angular.isArray(f)){for(var i=[],j=0;j<f.length;j++){var k=e(a,f[j]);g.populateChildren&&l(c+"/"+k[g.idField],k,h),i.push(k)}l(c,i,h)}else l(c,e(a,f),h)}function n(a,b,c,d){d&&a[b]&&a[b][d]&&a[b][d]!==c[d]&&delete a[b],k(a,b,c)}function o(a,b){if(!angular.isArray(a)||!angular.isFunction(b))return a;for(var c=[],d=a.length,e=0;d>e;e++)b(a[e])&&c.push(a[e]);return c}function p(a,b,c,d){c=!!c,a.toScope=function(e,g,h){if(J[b]){i(b);var j=o(J[b],h);n(e,g,c?f(j):j,d)}return a.then(function(a){n(e,g,o(a,h),d),!c&&angular.isArray(a)&&angular.isFunction(h)&&e.$on(H,function(a,c,f){b===c&&n(e,g,o(f,h),d)})}),a.then(function(){return e[g]})}}function q(b){var c=a.defer();return c.resolve(b),c.promise}function r(a,b){var c=a;if(b){var d=Object.keys(b);d.sort();for(var e=[],f=0;f<d.length;f++){var g=d[f];e.push(g+"="+escape(b[g]))}c+="?"+e.join("&")}return c}function s(a,c,d){b.$broadcast("model"+a+"Started",c,d),d["finally"](function(){b.$broadcast("model"+a+"Ended",c,d)})}function t(a,b,c){var e=d(a,b,c),g=r(e.ns,e.query),h=!!e.cloned,j=null;return e.useCached&&J[g]?(i(g),j=q(h?f(J[g]):J[g])):j=e.backend("GET",g,null,"getAll").then(function(b){return m(a,e,g,b),h?f(J[g]):J[g]}),p(j,g,h),j}function u(a,b,c,e){var g=d(a,b,e),h=g.ns+"/"+c,j=!!g.cloned,k=null;return g.useCached&&g.useCachedChildren&&J[h]?(i(h),k=q(j?f(J[h]):J[h])):k=g.backend("GET",h,null,"get").then(function(b){return m(a,g,h,b),j?f(J[h]):J[h]}),p(k,h,j,g.idField),k}function v(a,b){var c=d(a,b);if(!c.useCached)throw new Error("Can only use getAllSync on models that have useCached: true");var e=r(c.ns,c.query);return i(e),J[e]}function w(a,b,c){var e=d(a,b);if(!e.useCached)throw new Error("Can only use getSync on models that have useCached: true");var f=e.ns+"/"+c;return i(f),J[f]}function x(a,b,c,f){var g=d(a,b),h=c;if(f){h={};for(var i=0;i<f.length;i++)h[f[i]]=c[f[i]]}var k=g.ns+"/"+c[g.idField],m=g.backend("PUT",k,h,"update",c).then(function(b){var d=e(a,b);return l(k,d,g.cacheLife||0),j(d,c),delete c[G],J[k]});return p(m,k),s("Update",c,m),m}function y(a,c,e){var f=d(a,c),g="object"==typeof e?e[f.idField]:e,h=f.ns+"/"+g,i=f.backend("DELETE",h,null,"destroy",e).then(function(){delete J[h];var a=J[f.ns];if(a){for(var c=-1,d=0;d<a.length;d++)a[d][f.idField]===g&&(c=d);c>-1&&a.splice(c,1),b.$broadcast(H,f.ns,a)}});return s("Delete",e,i),i}function z(a,c,f){var g=d(a,c);f=f.constructor===a?f:e(a,f);var h=g.backend("POST",g.ns,f,"create",f).then(function(c){var d=e(a,c),h=g.ns+"/"+d[g.idField];l(h,d);var i=J[h];j(c,f),f[F]=i,delete f[G];var k=J[g.ns];if(k){for(var m=!1,n=0;n<k.length;n++)k[n][g.idField]===d[g.idField]&&(m=!0);m||k.push(i),b.$broadcast(H,g.ns,k)}return i});return s("Create",f,h),h}function A(){var a=this,b=a.constructor.modelOptions,c=!!a[G],d=null;return d=a[b.idField]?a.update():a.create(),s("Save",a,d),c?d.then(function(b){return a.snapshot(),b}):d}function B(){var a=this.constructor.modelOptions,b={};if(this[a.idField]){if(!this[F])throw new Error("Only works on clones!");b=this[F],this[G]&&(b=this[G])}else this[G]&&(b=this[G]);return!angular.equals(f(this),b)}function C(){var a=this.constructor.modelOptions;if(this[a.idField]&&!this[F])throw new Error("Only works on clones!");this[G]=f(this)}function D(a,b,c){return function(d){var e=angular.extend({},a.modelOptions,c,d);return b.apply(null,[a,e].concat(Array.prototype.slice.call(arguments,0)))}}function E(a){return function(){var b=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return a.apply(null,b)}}var F="$$cloneParent",G="$$snapshot",H="modelCached",I={idField:"id",populateChildren:!0,useCached:!1,useCachedChildren:!0},J={},K={},L=null,M=6e4,N=M,O={defaults:function(a){I=angular.extend(I,a)},extend:function(a,b){if(a.modelOptions)throw new Error("Cannot extend function that is already an optimistic model!");a.getAll=D(a,t),a.get=D(a,u),a.getCached=D(a,u,{useCached:!0}),a.getClone=D(a,u,{cloned:!0}),a.getAllSync=D(a,v),a.getSync=D(a,w),a.update=D(a,x),a["delete"]=D(a,y),a.create=D(a,z),a.cache=D(a,m),a.modelOptions=angular.extend({},I,b);var c=a.prototype;c.update=E(x),c["delete"]=E(y),c.create=E(z),c.save=A,c.hasChanges=B,c.snapshot=C},clear:function(){J={}},getCache:function(a){return i(a),J[a]},get:u,getAll:t,update:x,"delete":y,create:z,mkToScope:p,newInstance:e,now:g};return O}]);