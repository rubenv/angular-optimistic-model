angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b,c){return angular.extend({},a.modelOptions,b,c||{})}function d(a,b){var c,d=new a;if(b&&b.toJSON&&(b=b.toJSON()),d.fromJSON){var e={};for(c in b)"$"!==c[0]&&b.hasOwnProperty(c)&&(e[c]=angular.copy(b[c]));d.fromJSON(e)}else for(c in b)"$"!==c[0]&&b.hasOwnProperty(c)&&(d[c]=angular.copy(b[c]));return d}function e(a){if(angular.isArray(a)){for(var b=[],c=0;c<a.length;c++)b[c]=e(a[c]);return b}var f=d(a.constructor,a);return f[A]=a,f}function f(a,c){i(E,a,c),b.$broadcast(C,a,E[a])}function g(a,b,e,g){var h=c(a,b);if(!g&&angular.isArray(e)&&(g=e,e=h.ns),!g&&angular.isObject(e)&&(g=e,e=h.ns+"/"+g[h.idField]),g)if(angular.isArray(g)){for(var i=[],j=0;j<g.length;j++){var k=d(a,g[j]);h.populateChildren&&f(e+"/"+k[h.idField],k),i.push(k)}f(e,i)}else f(e,d(a,g))}function h(a,b){if(angular.isArray(a)){for(var c=0;c<a.length;c++)b[c]=a[c];b.length=a.length}else for(var d in a)"_"!==d[0]&&(b[d]=a[d])}function i(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];h(c,d)}}function j(a,b,c,d){d&&a[b]&&a[b][d]&&a[b][d]!==c[d]&&delete a[b],i(a,b,c)}function k(a,b){if(!angular.isArray(a)||!angular.isFunction(b))return a;for(var c=[],d=a.length,e=0;d>e;e++)b(a[e])&&c.push(a[e]);return c}function l(a,b,c,d){c=!!c,a.toScope=function(f,g,h){if(E[b]){var i=k(E[b],h);j(f,g,c?e(i):i,d)}return a.then(function(a){j(f,g,k(a,h),d),!c&&angular.isArray(a)&&angular.isFunction(h)&&f.$on(C,function(a,c,e){b===c&&j(f,g,k(e,h),d)})}),a.then(function(){return f[g]})}}function m(b){var c=a.defer();return c.resolve(b),c.promise}function n(a,c,d){b.$broadcast("model"+a+"Started",c,d),d["finally"](function(){b.$broadcast("model"+a+"Ended",c,d)})}function o(a,b,d){var f=c(a,b,d),h=f.ns,i=!!f.cloned,j=null;return j=f.useCached&&E[h]?m(i?e(E[h]):E[h]):f.backend("GET",h,null,"getAll").then(function(b){return g(a,f,h,b),i?e(E[h]):E[h]}),l(j,h,i),j}function p(a,b,d,f){var h=c(a,b,f),i=h.ns+"/"+d,j=!!h.cloned,k=null;return k=h.useCached&&h.useCachedChildren&&E[i]?m(j?e(E[i]):E[i]):h.backend("GET",i,null,"get").then(function(b){return g(a,h,i,b),j?e(E[i]):E[i]}),l(k,i,j,h.idField),k}function q(a,b){var d=c(a,b);if(!d.useCached)throw new Error("Can only use getAllSync on models that have useCached: true");var e=d.ns;return E[e]}function r(a,b,d){var e=c(a,b);if(!e.useCached)throw new Error("Can only use getSync on models that have useCached: true");var f=e.ns+"/"+d;return E[f]}function s(a,b,e,g){var i=c(a,b),j=e;if(g){j={};for(var k=0;k<g.length;k++)j[g[k]]=e[g[k]]}var m=i.ns+"/"+e[i.idField],o=i.backend("PUT",m,j,"update").then(function(b){var c=d(a,b);return f(m,c),h(c,e),delete e[B],E[m]});return l(o,m),n("Update",e,o),o}function t(a,d,e){var f=c(a,d),g="object"==typeof e?e[f.idField]:e,h=f.ns+"/"+g,i=f.backend("DELETE",h,null,"destroy").then(function(){delete E[h];var a=E[f.ns];if(a){for(var c=-1,d=0;d<a.length;d++)a[d][f.idField]===g&&(c=d);c>-1&&a.splice(c,1),b.$broadcast(C,f.ns,a)}});return n("Delete",e,i),i}function u(a,e,g){var i=c(a,e);g=g.constructor===a?g:d(a,g);var j=i.backend("POST",i.ns,g,"create").then(function(c){var e=d(a,c),j=i.ns+"/"+e[i.idField];f(j,e);var k=E[j];h(k,g),g[A]=k,delete g[B];var l=E[i.ns];if(l){for(var m=!1,n=0;n<l.length;n++)l[n][i.idField]===e[i.idField]&&(m=!0);m||l.push(k),b.$broadcast(C,i.ns,l)}return k});return n("Create",g,j),j}function v(){var a=this,b=a.constructor.modelOptions,c=!!a[B],d=null;return d=a[b.idField]?a.update():a.create(),n("Save",a,d),c?d.then(function(b){return a.snapshot(),b}):d}function w(){var a=this.constructor.modelOptions,b={};if(this[a.idField]){if(!this[A])throw new Error("Only works on clones!");b=this[A],this[B]&&(b=this[B])}else this[B]&&(b=this[B]);return!angular.equals(e(this),b)}function x(){var a=this.constructor.modelOptions;if(this[a.idField]&&!this[A])throw new Error("Only works on clones!");this[B]=e(this)}function y(a,b,c){return function(){var d=angular.extend({},a.modelOptions,c);return b.apply(null,[a,d].concat(Array.prototype.slice.call(arguments,0)))}}function z(a){return function(){var b=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return a.apply(null,b)}}var A="$$cloneParent",B="$$snapshot",C="modelCached",D={idField:"id",populateChildren:!0,useCached:!1,useCachedChildren:!0},E={},F={defaults:function(a){D=angular.extend(D,a)},extend:function(a,b){a.getAll=y(a,o),a.get=y(a,p),a.getCached=y(a,p,{useCached:!0}),a.getClone=y(a,p,{cloned:!0}),a.getAllSync=y(a,q),a.getSync=y(a,r),a.update=y(a,s),a["delete"]=y(a,t),a.create=y(a,u),a.cache=y(a,g),a.modelOptions=angular.extend({},D,b);var c=a.prototype;c.update=z(s),c["delete"]=z(t),c.create=z(u),c.save=v,c.hasChanges=w,c.snapshot=x},clear:function(){E={}},getCache:function(a){return E[a]},get:p,getAll:o,update:s,"delete":t,create:u,mkToScope:l};return F}]);