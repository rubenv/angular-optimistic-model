angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b,c){return angular.extend({},a.modelOptions,b,c||{})}function d(a,b){var c,d=new a;if(b&&b.toJSON&&(b=b.toJSON()),d.fromJSON){var e={};for(c in b)"$"===c[0]||angular.isFunction(b[c])||(e[c]=angular.copy(b[c]));d.fromJSON(e)}else for(c in b)"$"===c[0]||angular.isFunction(b[c])||(d[c]=angular.copy(b[c]));return d}function e(a){if(angular.isArray(a)){for(var b=[],c=0;c<a.length;c++)b[c]=e(a[c]);return b}var f=d(a.constructor,a);return f[z]=a,f}function f(a,c){i(D,a,c),b.$broadcast(B,a,D[a])}function g(a,b,e,g){var h=c(a,b);if(!g&&angular.isArray(e)&&(g=e,e=h.ns),!g&&angular.isObject(e)&&(g=e,e=h.ns+"/"+g[h.idField]),g)if(angular.isArray(g)){for(var i=[],j=0;j<g.length;j++){var k=d(a,g[j]);h.populateChildren&&f(e+"/"+k[h.idField],k),i.push(k)}f(e,i)}else f(e,d(a,g))}function h(a,b){if(angular.isArray(a)){for(var c=0;c<a.length;c++)b[c]=a[c];b.length=a.length}else for(var d in a)"_"!==d[0]&&(b[d]=a[d])}function i(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];h(c,d)}}function j(a,b,c,d){d&&a[b]&&a[b][d]&&a[b][d]!==c[d]&&delete a[b],i(a,b,c)}function k(a,b){if(!angular.isArray(a)||!angular.isFunction(b))return a;for(var c=[],d=a.length,e=0;d>e;e++)b(a[e])&&c.push(a[e]);return c}function l(a,b,c,d){c=!!c,a.toScope=function(f,g,h){if(D[b]){var i=k(D[b],h);j(f,g,c?e(i):i,d)}return a.then(function(a){j(f,g,k(a,h),d),!c&&angular.isArray(a)&&angular.isFunction(h)&&f.$on(B,function(a,c,e){b===c&&j(f,g,k(e,h),d)})}),a.then(function(){return f[g]})}}function m(b){var c=a.defer();return c.resolve(b),c.promise}function n(a,c,d){b.$broadcast("model"+a+"Started",c,d),d.finally(function(){b.$broadcast("model"+a+"Ended",c,d)})}function o(a,b,d){var f=c(a,b,d),h=f.ns,i=!!f.cloned,j=null;return j=f.useCached&&D[h]?m(i?e(D[h]):D[h]):f.backend("GET",h,null,"getAll").then(function(b){return g(a,f,h,b),i?e(D[h]):D[h]}),l(j,h,i),j}function p(a,b,d,f){var h=c(a,b,f),i=h.ns+"/"+d,j=!!h.cloned,k=null;return k=h.useCached&&h.useCachedChildren&&D[i]?m(j?e(D[i]):D[i]):h.backend("GET",i,null,"get").then(function(b){return g(a,h,i,b),j?e(D[i]):D[i]}),l(k,i,j,h.idField),k}function q(a,b,d){var e=c(a,b);if(!e.useCached)throw new Error("Can only use getSync on models that have useCached: true");var f=e.ns+"/"+d;return D[f]}function r(a,b,e,g){var i=c(a,b),j=e;if(g){j={};for(var k=0;k<g.length;k++)j[g[k]]=e[g[k]]}var m=i.ns+"/"+e[i.idField],o=i.backend("PUT",m,j,"update").then(function(b){var c=d(a,b);return f(m,c),h(c,e),delete e[A],D[m]});return l(o,m),n("Update",e,o),o}function s(a,d,e){var f=c(a,d),g="object"==typeof e?e[f.idField]:e,h=f.ns+"/"+g,i=f.backend("DELETE",h,null,"destroy").then(function(){delete D[h];var a=D[f.ns];if(a){for(var c=-1,d=0;d<a.length;d++)a[d][f.idField]===g&&(c=d);c>-1&&a.splice(c,1),b.$broadcast(B,f.ns,a)}});return n("Delete",e,i),i}function t(a,e,g){var i=c(a,e);g=g.constructor===a?g:d(a,g);var j=i.backend("POST",i.ns,g,"create").then(function(c){var e=d(a,c),j=i.ns+"/"+e[i.idField];f(j,e);var k=D[j];h(k,g),g[z]=k,delete g[A];var l=D[i.ns];if(l){for(var m=!1,n=0;n<l.length;n++)l[n][i.idField]===e[i.idField]&&(m=!0);m||l.push(k),b.$broadcast(B,i.ns,l)}return k});return n("Create",g,j),j}function u(){var a=this,b=a.constructor.modelOptions,c=!!a[A],d=null;return d=a[b.idField]?a.update():a.create(),n("Save",a,d),c?d.then(function(b){return a.snapshot(),b}):d}function v(){var a=this.constructor.modelOptions,b={};if(this[a.idField]){if(!this[z])throw new Error("Only works on clones!");b=this[z],this[A]&&(b=this[A])}else this[A]&&(b=this[A]);return!angular.equals(e(this),b)}function w(){var a=this.constructor.modelOptions;if(this[a.idField]&&!this[z])throw new Error("Only works on clones!");this[A]=e(this)}function x(a,b,c){return function(){var d=angular.extend({},a.modelOptions,c);return b.apply(null,[a,d].concat(Array.prototype.slice.call(arguments,0)))}}function y(a){return function(){var b=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return a.apply(null,b)}}var z="$$cloneParent",A="$$snapshot",B="modelCached",C={idField:"id",populateChildren:!0,useCached:!1,useCachedChildren:!0},D={},E={defaults:function(a){C=angular.extend(C,a)},extend:function(a,b){a.getAll=x(a,o),a.get=x(a,p),a.getCached=x(a,p,{useCached:!0}),a.getClone=x(a,p,{cloned:!0}),a.getSync=x(a,q),a.update=x(a,r),a.delete=x(a,s),a.create=x(a,t),a.cache=x(a,g),a.modelOptions=angular.extend({},C,b);var c=a.prototype;c.update=y(r),c.delete=y(s),c.create=y(t),c.save=u,c.hasChanges=v,c.snapshot=w},clear:function(){D={}},getCache:function(a){return D[a]},get:p,getAll:o,update:r,"delete":s,create:t,mkToScope:l};return E}]);