angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope","$interval",function(e,n,t){var r="$$cloneParent",a="$$snapshot",o="modelCached",i={idField:"id",populateChildren:!0,useCached:!1,useCachedChildren:!0},u={},l={},c=null,s=6e4,d=s;function f(e,n,t){return angular.extend({},e.modelOptions,n,t||{})}function h(e,n){var t,r=new e;if(n&&n.toJSON&&(n=n.toJSON()),r.fromJSON){var a={};for(t in n)"$"!==t[0]&&n.hasOwnProperty(t)&&(a[t]=angular.copy(n[t]));r.fromJSON(a)}else for(t in n)"$"!==t[0]&&n.hasOwnProperty(t)&&(r[t]=angular.copy(n[t]));return r}function v(e){if(angular.isArray(e)){for(var n=[],t=0;t<e.length;t++)n[t]=v(e[t]);return n}var a=h(e.constructor,e);return a[r]=e,a}function p(){return v(this)}function g(){for(var e=Object.keys(l),n=I.now(),r=!1,a=0;a<e.length;a++){var o=e[a],i=l[o];i.lastUse+i.cacheLife<n&&(delete u[o],delete l[o],r=!0)}r&&0===Object.keys(l).length&&(t.cancel(c),c=null,d=s)}function y(e){l[e]&&(l[e].lastUse=I.now())}function m(e,n){if(angular.isArray(e)){for(var t=0;t<e.length;t++)n[t]=e[t];n.length=e.length}else for(var r in e)e.hasOwnProperty(r)&&"_"!==r[0]&&"$"!==r[0]&&(n[r]=e[r])}function C(e,n,t){e[n]?e[n]!==t&&m(t,e[n]):e[n]=t}function w(e,r,a){if(a){var i=I.now();l[e]={lastUse:i,cacheLife:1e3*a},c?1e3*a<d&&(t.cancel(c),c=t(g,d=1e3*a)):c=t(g,d)}C(u,e,r),n.$broadcast(o,e,u[e])}function O(e,n,t,r){var a=f(e,n),o=a.cacheLife||0;if(!r&&angular.isArray(t)&&(r=t,t=a.ns),!r&&angular.isObject(t)&&(r=t,t=a.ns+"/"+r[a.idField]),r)if(angular.isArray(r)){for(var i=[],u=0;u<r.length;u++){var l=h(e,r[u]);a.populateChildren&&w(t+"/"+l[a.idField],l,o),i.push(l)}w(t,i,o)}else w(t,h(e,r),o)}function $(e,n,t,r){r&&e[n]&&e[n][r]&&e[n][r]!==t[r]&&delete e[n],C(e,n,t)}function b(e,n){if(!angular.isArray(e)||!angular.isFunction(n))return e;for(var t=[],r=e.length,a=0;a<r;a++)n(e[a])&&t.push(e[a]);return t}function F(e,n,t,r){t=!!t,e.toScope=function(a,i,l){if(u[n]){y(n);var c=b(u[n],l);$(a,i,t?v(c):c,r)}return e.then(function(e){$(a,i,b(e,l),r),!t&&angular.isArray(e)&&angular.isFunction(l)&&a.$on(o,function(e,t,o){n===t&&$(a,i,b(o,l),r)})}),e.then(function(){return a[i]})}}function S(n){var t=e.defer();return t.resolve(n),t.promise}function A(e,n){var t=e;if(n){var r=Object.keys(n);r.sort();for(var a=[],o=0;o<r.length;o++){var i=r[o];a.push(i+"="+escape(n[i]))}t+="?"+a.join("&")}return t}function k(e,t,r){n.$broadcast("model"+e+"Started",t,r),r.finally(function(){n.$broadcast("model"+e+"Ended",t,r)})}function E(e,n,t){var r=f(e,n,t),a=A(r.ns,r.query),o=!!r.cloned,i=null;return r.useCached&&u[a]?(y(a),i=S(o?v(u[a]):u[a])):i=r.backend("GET",a,null,"getAll").then(function(n){return O(e,r,a,n),o?v(u[a]):u[a]}),F(i,a,o),i}function T(e,n,t,r){var a=f(e,n,r),o=a.ns+"/"+t,i=!!a.cloned,l=null;return a.useCached&&a.useCachedChildren&&u[o]?(y(o),l=S(i?v(u[o]):u[o])):l=a.backend("GET",o,null,"get").then(function(n){return O(e,a,o,n),i?v(u[o]):u[o]}),F(l,o,i,a.idField),l}function j(e,n){var t=f(e,n);if(!t.useCached)throw new Error("Can only use getAllSync on models that have useCached: true");var r=A(t.ns,t.query);return y(r),u[r]}function x(e,n,t){var r=f(e,n);if(!r.useCached)throw new Error("Can only use getSync on models that have useCached: true");var a=r.ns+"/"+t;return y(a),u[a]}function P(e,n,t,r){var o=f(e,n),i=t;if(r){i={};for(var l=0;l<r.length;l++)i[r[l]]=t[r[l]]}var c=o.ns+"/"+t[o.idField],s=o.backend("PUT",c,i,"update",t).then(function(n){var r=h(e,n);return w(c,r,o.cacheLife||0),m(r,t),delete t[a],u[c]});return F(s,c),k("Update",t,s),s}function L(e,t,r){var a=f(e,t),i="object"==typeof r?r[a.idField]:r,l=a.ns+"/"+i,c=a.backend("DELETE",l,null,"destroy",r).then(function(){delete u[l];var e=u[a.ns];if(e){for(var t=-1,r=0;r<e.length;r++)e[r][a.idField]===i&&(t=r);t>-1&&e.splice(t,1),n.$broadcast(o,a.ns,e)}});return k("Delete",r,c),c}function U(e,t,i){var l=f(e,t);i=i.constructor===e?i:h(e,i);var c=l.backend("POST",l.ns,i,"create",i).then(function(t){var c=h(e,t),s=l.ns+"/"+c[l.idField];w(s,c);var d=u[s];m(t,i),i[r]=d,delete i[a];var f=u[l.ns];if(f){for(var v=!1,p=0;p<f.length;p++)f[p][l.idField]===c[l.idField]&&(v=!0);v||f.push(d),n.$broadcast(o,l.ns,f)}return d});return k("Create",i,c),c}function q(){var e=this,n=e.constructor.modelOptions,t=!!e[a],r=null;return r=e[n.idField]?e.update():e.create(),k("Save",e,r),t?r.then(function(n){return e.snapshot(),n}):r}function J(){var e={};if(this[this.constructor.modelOptions.idField]){if(!this[r])throw new Error("Only works on clones!");e=this[r],this[a]&&(e=this[a])}else this[a]&&(e=this[a]);return!angular.equals(v(this),e)}function N(){if(this[this.constructor.modelOptions.idField]&&!this[r])throw new Error("Only works on clones!");this[a]=v(this)}function D(e,n,t){return function(r){var a=angular.extend({},e.modelOptions,t,r);return n.apply(null,[e,a].concat(Array.prototype.slice.call(arguments,0)))}}function G(e){return function(){var n=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return e.apply(null,n)}}var I={defaults:function(e){i=angular.extend(i,e)},extend:function(e,n){if(e.modelOptions)throw new Error("Cannot extend function that is already an optimistic model!");e.getAll=D(e,E),e.get=D(e,T),e.getCached=D(e,T,{useCached:!0}),e.getClone=D(e,T,{cloned:!0}),e.getAllSync=D(e,j),e.getSync=D(e,x),e.update=D(e,P),e.delete=D(e,L),e.create=D(e,U),e.cache=D(e,O),e.modelOptions=angular.extend({},i,n);var t=e.prototype;t.update=G(P),t.delete=G(L),t.create=G(U),t.save=q,t.clone=p,t.hasChanges=J,t.snapshot=N},clear:function(){u={}},getCache:function(e){return y(e),u[e]},get:T,getAll:E,update:P,delete:L,create:U,mkToScope:F,newInstance:h,now:function(){return(new Date).getTime()}};return I}]);