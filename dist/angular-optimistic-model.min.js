angular.module("rt.optimisticmodel",[]).factory("Model",["$q","$rootScope",function(a,b){function c(a,b,c){return angular.extend({},a.modelOptions,b,c||{})}function d(a,b){var c,d=new a;if(b&&b.toJSON&&(b=b.toJSON()),d.fromJSON){var e={};for(c in b)"$"!==c[0]&&b.hasOwnProperty(c)&&(e[c]=angular.copy(b[c]));d.fromJSON(e)}else for(c in b)"$"!==c[0]&&b.hasOwnProperty(c)&&(d[c]=angular.copy(b[c]));return d}function e(a){if(angular.isArray(a)){for(var b=[],c=0;c<a.length;c++)b[c]=e(a[c]);return b}var f=d(a.constructor,a);return f[B]=a,f}function f(a,c){i(F,a,c),b.$broadcast(D,a,F[a])}function g(a,b,e,g){var h=c(a,b);if(!g&&angular.isArray(e)&&(g=e,e=h.ns),!g&&angular.isObject(e)&&(g=e,e=h.ns+"/"+g[h.idField]),g)if(angular.isArray(g)){for(var i=[],j=0;j<g.length;j++){var k=d(a,g[j]);h.populateChildren&&f(e+"/"+k[h.idField],k),i.push(k)}f(e,i)}else f(e,d(a,g))}function h(a,b){if(angular.isArray(a)){for(var c=0;c<a.length;c++)b[c]=a[c];b.length=a.length}else for(var d in a)"_"!==d[0]&&(b[d]=a[d])}function i(a,b,c){if(!a[b])return void(a[b]=c);if(a[b]!==c){var d=a[b];h(c,d)}}function j(a,b,c,d){d&&a[b]&&a[b][d]&&a[b][d]!==c[d]&&delete a[b],i(a,b,c)}function k(a,b){if(!angular.isArray(a)||!angular.isFunction(b))return a;for(var c=[],d=a.length,e=0;d>e;e++)b(a[e])&&c.push(a[e]);return c}function l(a,b,c,d){c=!!c,a.toScope=function(f,g,h){if(F[b]){var i=k(F[b],h);j(f,g,c?e(i):i,d)}return a.then(function(a){j(f,g,k(a,h),d),!c&&angular.isArray(a)&&angular.isFunction(h)&&f.$on(D,function(a,c,e){b===c&&j(f,g,k(e,h),d)})}),a.then(function(){return f[g]})}}function m(b){var c=a.defer();return c.resolve(b),c.promise}function n(a,b){var c=a;if(b){var d=Object.keys(b);d.sort();for(var e=[],f=0;f<d.length;f++){var g=d[f];e.push(g+"="+escape(b[g]))}c+="?"+e.join("&")}return c}function o(a,c,d){b.$broadcast("model"+a+"Started",c,d),d["finally"](function(){b.$broadcast("model"+a+"Ended",c,d)})}function p(a,b,d){var f=c(a,b,d),h=n(f.ns,f.query),i=!!f.cloned,j=null;return j=f.useCached&&F[h]?m(i?e(F[h]):F[h]):f.backend("GET",h,null,"getAll").then(function(b){return g(a,f,h,b),i?e(F[h]):F[h]}),l(j,h,i),j}function q(a,b,d,f){var h=c(a,b,f),i=h.ns+"/"+d,j=!!h.cloned,k=null;return k=h.useCached&&h.useCachedChildren&&F[i]?m(j?e(F[i]):F[i]):h.backend("GET",i,null,"get").then(function(b){return g(a,h,i,b),j?e(F[i]):F[i]}),l(k,i,j,h.idField),k}function r(a,b){var d=c(a,b);if(!d.useCached)throw new Error("Can only use getAllSync on models that have useCached: true");var e=n(d.ns,d.query);return F[e]}function s(a,b,d){var e=c(a,b);if(!e.useCached)throw new Error("Can only use getSync on models that have useCached: true");var f=e.ns+"/"+d;return F[f]}function t(a,b,e,g){var i=c(a,b),j=e;if(g){j={};for(var k=0;k<g.length;k++)j[g[k]]=e[g[k]]}var m=i.ns+"/"+e[i.idField],n=i.backend("PUT",m,j,"update").then(function(b){var c=d(a,b);return f(m,c),h(c,e),delete e[C],F[m]});return l(n,m),o("Update",e,n),n}function u(a,d,e){var f=c(a,d),g="object"==typeof e?e[f.idField]:e,h=f.ns+"/"+g,i=f.backend("DELETE",h,null,"destroy").then(function(){delete F[h];var a=F[f.ns];if(a){for(var c=-1,d=0;d<a.length;d++)a[d][f.idField]===g&&(c=d);c>-1&&a.splice(c,1),b.$broadcast(D,f.ns,a)}});return o("Delete",e,i),i}function v(a,e,g){var i=c(a,e);g=g.constructor===a?g:d(a,g);var j=i.backend("POST",i.ns,g,"create").then(function(c){var e=d(a,c),j=i.ns+"/"+e[i.idField];f(j,e);var k=F[j];h(k,g),g[B]=k,delete g[C];var l=F[i.ns];if(l){for(var m=!1,n=0;n<l.length;n++)l[n][i.idField]===e[i.idField]&&(m=!0);m||l.push(k),b.$broadcast(D,i.ns,l)}return k});return o("Create",g,j),j}function w(){var a=this,b=a.constructor.modelOptions,c=!!a[C],d=null;return d=a[b.idField]?a.update():a.create(),o("Save",a,d),c?d.then(function(b){return a.snapshot(),b}):d}function x(){var a=this.constructor.modelOptions,b={};if(this[a.idField]){if(!this[B])throw new Error("Only works on clones!");b=this[B],this[C]&&(b=this[C])}else this[C]&&(b=this[C]);return!angular.equals(e(this),b)}function y(){var a=this.constructor.modelOptions;if(this[a.idField]&&!this[B])throw new Error("Only works on clones!");this[C]=e(this)}function z(a,b,c){return function(d){var e=angular.extend({},a.modelOptions,c,d);return b.apply(null,[a,e].concat(Array.prototype.slice.call(arguments,0)))}}function A(a){return function(){var b=[this.constructor,this.constructor.modelOptions,this].concat(Array.prototype.slice.call(arguments,0));return a.apply(null,b)}}var B="$$cloneParent",C="$$snapshot",D="modelCached",E={idField:"id",populateChildren:!0,useCached:!1,useCachedChildren:!0},F={},G={defaults:function(a){E=angular.extend(E,a)},extend:function(a,b){a.getAll=z(a,p),a.get=z(a,q),a.getCached=z(a,q,{useCached:!0}),a.getClone=z(a,q,{cloned:!0}),a.getAllSync=z(a,r),a.getSync=z(a,s),a.update=z(a,t),a["delete"]=z(a,u),a.create=z(a,v),a.cache=z(a,g),a.modelOptions=angular.extend({},E,b);var c=a.prototype;c.update=A(t),c["delete"]=A(u),c.create=A(v),c.save=w,c.hasChanges=x,c.snapshot=y},clear:function(){F={}},getCache:function(a){return F[a]},get:q,getAll:p,update:t,"delete":u,create:v,mkToScope:l};return G}]);